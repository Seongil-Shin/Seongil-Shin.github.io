<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="next.js 최적화과정" /><meta name="author" content="신성일" /><meta property="og:locale" content="ko" /><meta name="description" content="학습 및 프로젝트 기록 블로그 React, Spring" /><meta property="og:description" content="학습 및 프로젝트 기록 블로그 React, Spring" /><link rel="canonical" href="https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/" /><meta property="og:url" content="https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/" /><meta property="og:site_name" content="디피의 개발일지" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-10-22T16:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="next.js 최적화과정" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"신성일"},"dateModified":"2023-10-22T16:00:00+09:00","datePublished":"2023-10-22T16:00:00+09:00","description":"학습 및 프로젝트 기록 블로그 React, Spring","headline":"next.js 최적화과정","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/"},"url":"https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/"}</script><title>next.js 최적화과정 | 디피의 개발일지</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HC9W0NGRV0"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HC9W0NGRV0'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">디피의 개발일지</a></div><div class="site-subtitle font-italic">개인 학습 및 프로젝트 기록</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Seongil-Shin" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['callmeshin75','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/%EC%84%B1%EC%9D%BC-%EC%8B%A0-a9411b237/" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>next.js 최적화과정</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>next.js 최적화과정</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> 신성일 </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 22, 2023, 4:00 PM +0900" prep="on" > Oct 22, 2023 <i class="unloaded">2023-10-22T16:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2314 words">12 min</span></div></div><div class="post-content"><h2 id="발단">발단</h2><p>서비스를 운영하던 도중 CPU/Memory 사용량은 낮은데 사용자 응답이 매우 느려지는 상황이 발생하였다. 서비스는 쿠버네티스로 띄워져있었고, HPA metric으로 CPU와 memory가 걸려있었는데, CPU와 memory가 올라가지 않으니 scale-out도 발생하지 않아 적은 pod으로 계속 서비스 되고 있었다. 수동으로 pod을 3~4배 가량 늘려 대응은 하였으나 추후에도 발생할 이슈일 것으로 보여 대응을 하기로 했다.</p><h2 id="테스트">테스트</h2><p>이 이슈는 next.js로 띄워져있는 페이지 중 하나에 페이지에 갑자기 트래픽이 몰려 발생한 이슈였다. 따라서 당시 리얼환경과 비슷하게 환경 세팅을 하고 <a href="https://naver.github.io/ngrinder/">ngrinder</a>를 사용하여 대규모 트래픽 테스트를 하였다. 이슈가 발생했던 페이지를 포함하여 다양한 페이지를 테스트한 결과는 다음과 같았다. (TPS가 낮음 -&gt; 성능이 낮음)</p><ul><li>페이지 A (이슈가 발생했던 페이지) : TPS 매우 낮음.<li>페이지 B : TPS 낮음<li>페이지 C : TPS 중간<li>페이지 D : TPS 높음<li>페이지 E : TPS 매우 높음</ul><p>해당 페이지들은 다음과 같은 특징을 가지고 있다.</p><ul><li>페이지 A (TPS 매우 낮음.)<ul><li>동적 페이지<li>API 소스 A’로의 요청 2개, 소스 B’로의 요청 1개<li>API 소스 A’는 C’로부터 데이터를 중개해주는 역할을 함.</ul><li>페이지 B (TPS 낮음)<ul><li>동적페이지<li>API 소스 B’로의 요청 1개</ul><li>페이지 C (TPS 중간)<ul><li>동적페이지<li>API 소스 A’로의 요청 2개<li>이 A’로 간 API 두개는 A’가 DB로부터 바로 데이터를 가져옴.</ul><li>페이지 D (TPS 높음)<ul><li>동적페이지<li>API 요청 없음</ul><li>페이지 E (TPS 매우 높음)<ul><li>정적페이지</ul></ul><p>이 결과들을 보고 내린 결론은 다음과 같다.</p><ul><li>성능 저하가 크지 않은 경우<ul><li>next.js 내에서만 연산이 이루어지는 경우 (페이지 D, E)<li>A’로 보내는 API 중 A’가 스스로 처리하는 API를 사용하는 경우 (페이지 C)</ul><li>성능 저하가 큰 경우<ul><li>A’로 보내는 API 중 A’가 중개 API 로써 동작하는 경우 (페이지 A)<li>B’로 API를 요청하는 경우 (페이지 A, B)</ul></ul><h2 id="최적화">최적화</h2><p>아래 두 전략을 가지고 최적화를 진행하였다.</p><ol><li>API 요청을 최소화하기<li>요청량을 기준으로 HPA metric을 산정하기</ol><p>자세한 내용은 다음과 같다.</p><h3 id="api-요청-최소화하기">API 요청 최소화하기</h3><p>기본적으로 API 요청이 발생하는 페이지에서 성능저하가 발생하였다. 따라서 API 요청을 최소화하는게 최우선 목표라고 생각하였다.</p><h4 id="불필요한-호출-줄이기">불필요한 호출 줄이기</h4><p>가장 성능이 안좋았던 페이지 A는 A’로 API 요청을 2개 보내고, B’로 1개의 요청을 보낸다. A’로 보내는 두개의 요청은 기존에는 다음과 같이 코드가 짜여있었다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">const</span> <span class="nx">getServerSideProps</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="p">...</span>
	<span class="kd">const</span> <span class="nx">userProfileData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getUserProfileData</span><span class="p">();</span>
	<span class="kd">const</span> <span class="nx">userContentData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getUserContentData</span><span class="p">();</span>
	<span class="p">...</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="na">props</span> <span class="p">:</span> <span class="p">{</span>
			<span class="nx">userData</span><span class="p">,</span>
			<span class="nx">userContentData</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">getUserProfileData()</code> 와 <code class="language-plaintext highlighter-rouge">getUserContentData()</code>는 유저가 로그인 되어있든 안되어있든 항상 A’로 요청을 보낸다. 그리고 A’는 로그인 되어있지 않으면 null을 응답한다. 처음 이 코드를 짰을때는 성능에 대해 크게 걱정이 없어서 이렇게 항상 요청하는 식으로 짰다.(코드 조금 더 쓰기 귀찮았다..) 하지만 로그인 여부는 next.js 단에서도 API 요청 없이 알 수 있도록 설정이 되어있었다. 따라서 다음과 같이 next.js 에서 먼저 로그인 여부를 확인하고 로그인 되어있으면 요청하는 식으로 코드를 변경하였다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">const</span> <span class="nx">getServerSideProps</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="p">{</span> <span class="nx">isLoggedIn</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">getAuthentication</span><span class="p">();</span>
	<span class="p">...</span>
	<span class="kd">let</span> <span class="nx">userProfileData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">userContentData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">isLoggedIn</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">userProfileData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getUserProfileData</span><span class="p">();</span>
		<span class="nx">userContentData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getUserContentData</span><span class="p">();</span>

	<span class="p">}</span>
	<span class="p">...</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="na">props</span> <span class="p">:</span> <span class="p">{</span>
			<span class="nx">userData</span><span class="p">,</span>
			<span class="nx">userContentData</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>이로써 미로그인 유저들이 불필요한 API 요청을 보내는 일이 없어졌다. 조금 더 개선을 하자면, <code class="language-plaintext highlighter-rouge">getUserProfileData()</code> 와 <code class="language-plaintext highlighter-rouge">getUserContentData()</code>를 하나의 API로 합칠 수도 있으나 이건 API 개발자의 작업이니 이 글에선 자세히 작성하진 않겠다.</p><p>또 여기서 한번 더 최적화를 한다면 다음과 같이 <code class="language-plaintext highlighter-rouge">Promise.all</code>을 사용하여 요청을 동시에 보낼 수도 있다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">const</span> <span class="nx">getServerSideProps</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="p">{</span> <span class="nx">isLoggedIn</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">getAuthentication</span><span class="p">();</span>
	<span class="p">...</span>
	<span class="kd">let</span> <span class="nx">userProfileData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">userContentData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="nx">isLoggedIn</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">[</span><span class="nx">userProfileData</span><span class="p">,</span> <span class="nx">userContentData</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">all</span><span class="p">([</span><span class="nf">getUserProfileData</span><span class="p">(),</span> <span class="nf">getUserContentData</span><span class="p">()])</span>
	<span class="p">}</span>
	<span class="p">...</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="na">props</span> <span class="p">:</span> <span class="p">{</span>
			<span class="nx">userData</span><span class="p">,</span>
			<span class="nx">userContentData</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>기존에는 <code class="language-plaintext highlighter-rouge">getUserProfileData()</code>의 응답시간 + <code class="language-plaintext highlighter-rouge">getUserContentData()</code>의 응답시간으로 최종 응답시간이 정해졌으나, <code class="language-plaintext highlighter-rouge">Promise.all</code>을 사용하면 둘 중 더 느린 응답시간으로 최종 응답시간이 결정되기 때문이다.</p><h4 id="캐시-사용">캐시 사용</h4><p>다음은 B’로 보내는 요청을 최적화한 방법이다. B’는 콘텐츠를 가져오는 API로 기존에는 매요청마다 호출하고 있었다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">const</span> <span class="nx">getServerSideProps</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="p">...</span>
	<span class="kd">const</span> <span class="nx">contentData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getContentData</span><span class="p">(</span><span class="dl">'</span><span class="s1">page-a</span><span class="dl">'</span><span class="p">);</span>
	<span class="p">...</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="na">props</span> <span class="p">:</span> <span class="p">{</span>
			<span class="nx">contentData</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>콘텐츠의 내용이 변경가능하여 항상 호출하였으나, 변경 사항을 즉시 반영해야할 심각도를 가진 콘텐츠는 아니었다. 즉 캐시를 사용하여 콘텐츠 변경의 반영이 어느정도 늦어져도 문제는 없었다. 따라서 <a href="https://www.npmjs.com/package/memory-cache">memory-cache</a>라는 in-memory cache 을 쉽게 사용할 수 있게 도와주는 라이브러리를 사용하기로 하였다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">cacheData</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">memory-cache</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">getServerSideProps</span> <span class="o">=</span> <span class="k">async</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="p">...</span>
	<span class="kd">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">page-a</span><span class="dl">"</span>
	<span class="kd">let</span> <span class="nx">contentData</span> <span class="o">=</span> <span class="nx">cacheData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
	<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">contentData</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">contentData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getContentData</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
		<span class="nx">cacheData</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">contentData</span><span class="p">,</span> <span class="mi">60000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="p">...</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="na">props</span> <span class="p">:</span> <span class="p">{</span>
			<span class="nx">contentData</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>이렇게 두가지만 적용한 후, 다시 페이지 A를 ngrinder로 테스트한 결과는 다음과 같았다.</p><ul><li>미로그인 유저 -&gt; TPS 15배 상승<li>로그인 유저 -&gt; TPS 2~3배 상승 로그인 유저의 경우 미로그인 유저에 비해 상승량은 적었지만 기존보다는 크게 상승했다.</ul><h3 id="hpa-metric을-요청량-기준으로-변경">HPA metric을 요청량 기준으로 변경</h3><p>이번 이슈를 겪으면서 알게 된 것은 CPU, Memory 사용량이 많아져서 응답이 느리게 갈 가능성은 적다는 것이었다. 정적페이지 및 API 요청 없는 동적페이지의 경우 매우 빠르게 처리하고 있었고, pod 개수도 많아서 예상되는 최대치의 트래픽이 들어오더라도 CPU, Memory 사용량이 많이 점유되는 가능성은 적었다. 반대로 API 요청이 발생하는 페이지에서는 예상보다 훨씬 적은 트래픽이 들어오더라도 터지는 일이 발생하였다.</p><p>따라서 서버 응답 장애가 발생한다면, CPU/Memory 사용량은 낮지만 API 요청이 발생하는 페이지에 요청이 몰려 발생할 확률이 훨씬 컸다.</p><p>이에따라 기존에는 HPA metric을 다음과 같이 CPU/Memory 기준으로 작성하였는데, network 요청량이 일정 수준이상이 되면 발생하도록 변경하기로 하였다. (아래 yaml 파일들은 실제 파일이 아닌 예시)</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1"># 기존 hpa 설정</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">next-app-hpa</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">scaleTargetRef</span><span class="pi">:</span>
        <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">next-app</span>
    <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">targetCPUUtilizationPercentage</span><span class="pi">:</span> <span class="m">50</span> <span class="c1"># CPU가 50%로 맞춰지도록 스케일링 발생</span>
    <span class="na">targetmemoryutilizationpercentage</span><span class="pi">:</span> <span class="m">50</span> <span class="c1"># Memory가 50%로 맞춰지도록 스케일링 발생</span>
</pre></table></code></div></div><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1"># 변경한 hpa 설정</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v2beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">next-app-hpa</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
    <span class="na">scaleTargetRef</span><span class="pi">:</span>
        <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">next-app</span>
    <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">metrics</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">object</span><span class="pi">:</span>
              <span class="na">describedObject</span><span class="pi">:</span>
                  <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
                  <span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">test</span>
              <span class="na">metric</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">test_requests_per_second</span>
              <span class="na">target</span><span class="pi">:</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">Value</span>
                  <span class="na">value</span><span class="pi">:</span> <span class="m">200</span> <span class="c1"># 초당 200번 이상 요청이 들어올 시 scale-out 발생</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">Object</span>
        <span class="pi">-</span> <span class="na">resource</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">cpu</span> <span class="c1"># CPU 설정도 혹시 모르니 남겨둠(CPU가 터지는 상항이 생길 수 있으니..)</span>
              <span class="na">target</span><span class="pi">:</span>
                  <span class="na">averageUtilization</span><span class="pi">:</span> <span class="m">50</span>
                  <span class="na">type</span><span class="pi">:</span> <span class="s">Utilization</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">Resource</span>
</pre></table></code></div></div><p><a href="https://tech.scatterlab.co.kr/kubernetes-hpa-custom-metric/">참고</a></p><p>다시 ngrinder로 테스트를 하니 scale-out 이 정상적으로 동작하였다. 이 두가지 방법을 적용하여 최적화를 완료하였고, 이후 트래픽이 많이 발생하여도 정상적으로 대응 가능하였다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/study/'>study</a>, <a href='/categories/next-js/'>next.js</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/next-js/" class="post-tag no-text-decoration" >next.js</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=next.js 최적화과정 - 디피의 개발일지&url=https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=next.js 최적화과정 - 디피의 개발일지&u=https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=next.js 최적화과정 - 디피의 개발일지&url=https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/You-don't-know-JS-Yet-1%EC%9E%A5-%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8/">You don't know JS Yet - 1장 자바스크립트</a><li><a href="/posts/why-nextjs-sucks/">why-nextjs-sucks</a><li><a href="/posts/the-state-of-es5-on-the-web/">the state of es5 on the web</a><li><a href="/posts/%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8%EC%9D%98-%EB%87%8C-3%EC%9E%A5-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EB%AC%B8%EB%B2%95-%EB%B9%A0%EB%A5%B4%EA%B2%8C-%EB%B0%B0%EC%9A%B0%EA%B8%B0/">프로그래머의 뇌 3장 프로그래밍 문법 빠르게 배우기</a><li><a href="/posts/%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8%EC%9D%98-%EB%87%8C-4%EC%9E%A5-%EB%B3%B5%EC%9E%A1%ED%95%9C-%EC%BD%94%EB%93%9C-%EC%9D%BD%EB%8A%94-%EB%B0%A9%EB%B2%95/">프로그래머의 뇌 4장 복잡한 코드 읽는 방법</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/study/">#study</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/next-js/">next.js</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/db/">db</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/java/">java</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/next.js-data-fetching/"><div class="card-body"> <span class="timeago small" > Jan 23, 2023 <i class="unloaded">2023-01-23T22:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>next.js - data fetching</h3><div class="text-muted small"><p> next.js에서 사용자의 요청을 받고, 페이지를 만들어낼 때 외부 서버로 필요한 데이터를 요청해야할 때 사용하는 기법이다. data fetching은 기본적으로 페이지 컴포넌트에서 사용할 수 있고 경우에 따라 Custom App 컴포넌트에서도 사용할 수 있다. next 13부터는 app/ 구조를 사용한다면 일반 컴포넌트에서도 가능하다고 하지만, 현...</p></div></div></a></div><div class="card"> <a href="/posts/next.js-next-image-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8/"><div class="card-body"> <span class="timeago small" > Jan 28, 2023 <i class="unloaded">2023-01-28T23:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>next/image 컴포넌트</h3><div class="text-muted small"><p> next.js에서는 next/image로 자체적인 이미지 컴포넌트를 제공한다. 일반적인 img 태그와는 달리 여러 성능 최적화기법이 내장되어있다. 기본적으로 다음과 같은 기능을 제공한다. 성능 향상 : 각 디바이스에 정확히 맞는 이미지를 모던 웹 포맷에 맞게 제공한다. Visual Stability : Cumulative Layout Shi...</p></div></div></a></div><div class="card"> <a href="/posts/next.js-Automatic-Static-%EC%B5%9C%EC%A0%81%ED%99%94/"><div class="card-body"> <span class="timeago small" > Jan 29, 2023 <i class="unloaded">2023-01-29T22:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>next.js - Automatic Static 최적화</h3><div class="text-muted small"><p> next.js에서는 어떤 페이지가 getServerSideProps 또는 getInitialProps를 가지고 있지 않다면, static 페이지로 결정한다. 이렇게 static 페이지로 결정되면, 빌드시 그 페이지는 static 페이지로 빌드된다. static 페이지는 서버사이드에서 렌더되지 않고 바로 유저에게 전달된다. end-user와 서버 사이...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/next-caching/" class="btn btn-outline-primary" prompt="Older"><p>next.js caching</p></a> <a href="/posts/%EC%8B%A4%EC%9A%A9%EC%A3%BC%EC%9D%98%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%A8%B8-1%EC%9E%A5-%EC%8B%A4%EC%9A%A9%EC%A3%BC%EC%9D%98-%EC%B2%A0%ED%95%99/" class="btn btn-outline-primary" prompt="Newer"><p>실용주의프로그래머 1장 실용주의 철학</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'next.js 최적화과정'; this.page.url = 'https://seongil-shin.github.io/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/'; this.page.identifier = '/posts/next.js-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B3%BC%EC%A0%95/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Seongil-Shin">ShinSeongil</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/study/">#study</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/next-js/">next.js</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/db/">db</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/java/">java</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://seongil-shin.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
